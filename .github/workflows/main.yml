name: Build Kernel

on:
  workflow_dispatch:

jobs:
  build-kernel:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout Source
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git ccache automake flex lzop bison \
        gperf build-essential zip curl zlib1g-dev g++-multilib libxml2-utils \
        bzip2 libbz2-dev libbz2-1.0 libghc-bzlib-dev squashfs-tools pngcrush \
        schedtool dpkg-dev liblz4-tool make optipng maven libssl-dev \
        pwgen libswitch-perl policycoreutils minicom libxml-simple-perl \
        libxml-sax-base-perl libxml-sax-expat-perl bc libncurses5-dev \
        lib32ncurses5-dev lib32readline-dev lib32z1-dev liblz4-dev \
        libncurses5-dev libsdl1.2-dev libwxgtk3.0-gtk3-dev libxml2 \
        lzop pngcrush schedtool squashfs-tools imagemagick xsltproc zip \
        zlib1g-dev python3 python3-pip wget coreutils

    - name: Setup KernelSU (MamboSU)
      run: |
        echo "Applying KernelSU Patch..."
        curl -LSs "https://raw.githubusercontent.com/RapliVx/KernelSU/refs/heads/susfs-rksu-master/kernel/setup.sh" | bash -s susfs-rksu-master
        echo "KernelSU Setup Complete."

    - name: Run Build Script
      env:
        TG_TOKEN: ${{ secrets.TG_TOKEN }}
        TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        NAME_KERNEL: "FranxxCORE"
        
      run: |
        chmod +x compile.sh
        ./compile.sh

    - name: Upload Artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: Kernel-Packages
        path: final_zips/*.zip
        retention-days: 5
        
    - name: Send File to Telegram
      if: success()
      env:
        CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        BOT_TOKEN: ${{ secrets.TG_TOKEN }}
      run: |
        # Debug: Cek permission dan ukuran file sebelum upload
        ls -lah final_zips/

        if [ -d "final_zips" ] && [ "$(ls -A final_zips)" ]; then
          echo "Files found, uploading to Telegram..."
          
          for FILE in final_zips/*.zip; do
            echo "Uploading: $FILE"
            
            FILENAME=$(basename "$FILE")
            
            # PERBAIKAN: Gunakan "$(pwd)/$FILE" agar curl membaca Full Path
            curl -v -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
              -F chat_id="${CHAT_ID}" \
              -F document=@"$(pwd)/$FILE" \
              -F parse_mode="HTML" \
              -F caption="<b>‚úÖ Build Complete!</b>%0A%0A<b>üìÅ File:</b> <code>$FILENAME</code>%0A<b>üìÖ Date:</b> $(date)"
          done
        else
          echo "No ZIP files found in final_zips/."
        fi
        
